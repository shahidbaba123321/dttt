<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SuperAdmin Dashboard - WorkWise Pro</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #4F46E5;
            --secondary-color: #4338CA;
            --accent-color: #818CF8;
            --success-color: #10B981;
            --warning-color: #F59E0B;
            --danger-color: #EF4444;
            --background-color: #F8FAFC;
            --text-color: #1F2937;
            --light-text: #64748B;
            --sidebar-width: 280px;
            --header-height: 70px;
            --gradient-start: #EEF2FF;
            --gradient-end: #E0E7FF;
            --box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Poppins', sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--background-color);
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Layout */
        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background: white;
            border-right: 1px solid rgba(0, 0, 0, 0.1);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sidebar-menu {
            padding: 1rem 0;
        }

        .menu-section {
            margin-bottom: 1rem;
        }

        .menu-section-title {
            padding: 0.75rem 1.5rem;
            font-size: 0.875rem;
            color: var(--light-text);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .menu-item {
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--text-color);
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .menu-item:hover {
            background: var(--gradient-start);
            color: var(--primary-color);
        }

        .menu-item.active {
            background: var(--primary-color);
            color: white;
        }

        .menu-item i {
            width: 1.5rem;
            text-align: center;
        }

        .submenu {
            padding-left: 1rem;
            display: none;
        }

        .submenu.active {
            display: block;
        }

        .submenu .menu-item {
            padding-left: 2.5rem;
        }

        /* Header Styles */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            min-height: 100vh;
        }

        .header {
            height: var(--header-height);
            background: white;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            position: fixed;
            top: 0;
            right: 0;
            left: var(--sidebar-width);
            z-index: 999;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .toggle-sidebar {
            display: none;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-color);
            font-size: 1.25rem;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-menu {
            position: relative;
        }

        .user-trigger {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-trigger:hover {
            background: var(--gradient-start);
        }

        .user-avatar {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .user-info {
            display: none;
        }

        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 0.5rem;
            box-shadow: var(--box-shadow);
            min-width: 200px;
            padding: 0.5rem 0;
            display: none;
            z-index: 1000;
        }

        .user-dropdown.active {
            display: block;
        }

        .dropdown-item {
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--text-color);
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .dropdown-item:hover {
            background: var(--gradient-start);
            color: var(--primary-color);
        }

        .dropdown-divider {
            height: 1px;
            background: rgba(0, 0, 0, 0.1);
            margin: 0.5rem 0;
        }

        /* Content Area */
        .content {
            padding: calc(var(--header-height) + 2rem) 2rem 2rem;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .header {
                left: 0;
            }

            .toggle-sidebar {
                display: block;
            }

            .user-info {
                display: none;
            }
        }

        @media (min-width: 1024px) {
            .user-info {
                display: block;
            }
        }

        /* Notification Styles */
        .notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            background: white;
            box-shadow: var(--box-shadow);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transform: translateX(120%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left: 4px solid var(--success-color);
        }

        .notification.error {
            border-left: 4px solid var(--danger-color);
        }

        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 1.5rem;
            height: 1.5rem;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
    </style>
    <style>
        /* User Management Styles */
.users-container {
    padding: 1.5rem;
}

.users-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.search-filter-container {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.search-bar {
    flex: 1;
    position: relative;
}

.search-bar input {
    width: 100%;
    padding: 0.75rem 1rem 0.75rem 2.5rem;
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 0.5rem;
    font-size: 0.875rem;
}

.search-bar i {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--light-text);
}

.filter-dropdown {
    position: relative;
}

.filter-button {
    padding: 0.75rem 1rem;
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 0.5rem;
    background: white;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    font-size: 0.875rem;
}

.filter-menu {
    position: absolute;
    top: 100%;
    right: 0;
    background: white;
    border-radius: 0.5rem;
    box-shadow: var(--box-shadow);
    min-width: 200px;
    display: none;
    z-index: 100;
}

.filter-menu.active {
    display: block;
}

.filter-option {
    padding: 0.75rem 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.filter-option:hover {
    background: var(--gradient-start);
}

/* Table Styles */
.users-table {
    width: 100%;
    background: white;
    border-radius: 0.5rem;
    box-shadow: var(--box-shadow);
    overflow: hidden;
}

.users-table table {
    width: 100%;
    border-collapse: collapse;
}

.users-table th,
.users-table td {
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

.users-table th {
    background: var(--gradient-start);
    font-weight: 600;
    color: var(--text-color);
}

.users-table tr:hover {
    background: var(--gradient-start);
}

.user-status {
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.875rem;
    font-weight: 500;
}

.status-active {
    background: var(--success-color);
    color: white;
}

.status-inactive {
    background: var(--danger-color);
    color: white;
}

.user-actions {
    display: flex;
    gap: 0.5rem;
}

.action-button {
    padding: 0.5rem;
    border: none;
    border-radius: 0.25rem;
    background: none;
    color: var(--text-color);
    cursor: pointer;
    transition: all 0.3s ease;
}

.action-button:hover {
    color: var(--primary-color);
}

/* Pagination Styles */
.pagination {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 1.5rem;
    padding: 1rem;
    background: white;
    border-radius: 0.5rem;
    box-shadow: var(--box-shadow);
}

.pagination-info {
    font-size: 0.875rem;
    color: var(--light-text);
}

.pagination-buttons {
    display: flex;
    gap: 0.5rem;
}

.pagination-button {
    padding: 0.5rem 1rem;
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 0.25rem;
    background: white;
    cursor: pointer;
    transition: all 0.3s ease;
}

.pagination-button:hover {
    background: var(--gradient-start);
}

.pagination-button.active {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

.pagination-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* Modal Styles */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal.active {
    display: flex;
}

.modal-content {
    background: white;
    border-radius: 0.5rem;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
}

.modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--light-text);
}

.modal-body {
    padding: 1.5rem;
}

.modal-footer {
    padding: 1.5rem;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
}

/* Form Styles */
.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
}

.form-group input,
.form-group select {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 0.5rem;
    font-size: 0.875rem;
}

.form-group input:focus,
.form-group select:focus {
    border-color: var(--primary-color);
    outline: none;
}

/* Button Styles */
.btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 0.5rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-primary {
    background: var(--primary-color);
    color: white;
}

.btn-secondary {
    background: var(--light-text);
    color: white;
}

.btn-danger {
    background: var(--danger-color);
    color: white;
}

.btn:hover {
    opacity: 0.9;
}
    </style>
  <div class="dashboard-container">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="#" class="logo">
                <i class="fas fa-briefcase"></i>
                WorkWise Pro
            </a>
            <button class="toggle-sidebar" id="closeSidebar">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <nav class="sidebar-menu">
            <div class="menu-section">
                <a href="#dashboard" class="menu-item active" data-section="dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard Overview</span>
                </a>
            </div>

            <div class="menu-section">
                <div class="menu-section-title">Management</div>
                <a href="#companies" class="menu-item" data-section="companies">
                    <i class="fas fa-building"></i>
                    <span>Companies/Organizations</span>
                </a>
            </div>

            <div class="menu-section">
                <div class="menu-section-title">System</div>
                <div class="menu-item" onclick="toggleSubmenu('systemSettings')">
                    <i class="fas fa-cogs"></i>
                    <span>System Settings</span>
                    <i class="fas fa-chevron-down ml-auto"></i>
                </div>
                <div class="submenu" id="systemSettings">
                    <a href="#general-settings" class="menu-item">
                        <i class="fas fa-sliders-h"></i>
                        <span>General Settings</span>
                    </a>
                    <a href="#pricing-plans" class="menu-item">
                        <i class="fas fa-tags"></i>
                        <span>Pricing & Plans</span>
                    </a>
                    <a href="#security-settings" class="menu-item">
                        <i class="fas fa-shield-alt"></i>
                        <span>Security Settings</span>
                    </a>
                </div>
            </div>

            <div class="menu-section">
                <div class="menu-section-title">Management</div>
                <div class="menu-item" onclick="toggleSubmenu('moduleManagement')">
                    <i class="fas fa-cubes"></i>
                    <span>Modules Management</span>
                    <i class="fas fa-chevron-down ml-auto"></i>
                </div>
                <div class="submenu" id="moduleManagement">
                    <a href="#modules-list" class="menu-item">
                        <i class="fas fa-list"></i>
                        <span>Modules List</span>
                    </a>
                    <a href="#module-settings" class="menu-item">
                        <i class="fas fa-wrench"></i>
                        <span>Module Settings</span>
                    </a>
                </div>

                <div class="menu-item" onclick="toggleSubmenu('userManagement')">
                    <i class="fas fa-users"></i>
                    <span>User Management</span>
                    <i class="fas fa-chevron-down ml-auto"></i>
                </div>
                <div class="submenu" id="userManagement">
                    <a href="#" class="menu-item" data-section="users-list">
        <i class="fas fa-user-friends"></i>
        <span>Users List</span>
    </a>
                    <a href="#" class="menu-item" data-section="roles-permissions">
        <i class="fas fa-user-lock"></i>
        <span>Roles & Permissions</span>
    </a>
                </div>
            </div>

            <div class="menu-section">
                <div class="menu-section-title">Tools</div>
                <a href="#analytics" class="menu-item">
                    <i class="fas fa-chart-line"></i>
                    <span>Analytics & Reports</span>
                </a>
                <a href="#backup" class="menu-item">
                    <i class="fas fa-database"></i>
                    <span>Backup & Restore</span>
                </a>
                <a href="#audit-logs" class="menu-item">
                    <i class="fas fa-history"></i>
                    <span>Audit Logs</span>
                </a>
                <a href="#api-management" class="menu-item">
                    <i class="fas fa-code"></i>
                    <span>API Management</span>
                </a>
            </div>

            <div class="menu-section">
                <div class="menu-section-title">Support</div>
                <a href="#support-center" class="menu-item">
                    <i class="fas fa-headset"></i>
                    <span>Support Center</span>
                </a>
            </div>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <header class="header">
            <div class="header-left">
                <button class="toggle-sidebar" id="toggleSidebar">
                    <i class="fas fa-bars"></i>
                </button>
                <h2 id="pageTitle">Dashboard Overview</h2>
            </div>

            <div class="header-right">
                <div class="user-menu">
                    <div class="user-trigger" onclick="toggleUserMenu()">
                        <div class="user-avatar" id="userAvatar">
                            <!-- Will be set by JS -->
                        </div>
                        <div class="user-info">
                            <div id="userName">Loading...</div>
                            <div id="userRole" style="font-size: 0.8rem; color: var(--light-text)">
                                SuperAdmin
                            </div>
                        </div>
                        <i class="fas fa-chevron-down"></i>
                    </div>

                    <div class="user-dropdown" id="userDropdown">
                        <a href="#my-account" class="dropdown-item" onclick="openMyAccount()">
                            <i class="fas fa-user"></i>
                            <span>My Account</span>
                        </a>
                        <a href="#settings" class="dropdown-item">
                            <i class="fas fa-cog"></i>
                            <span>Settings</span>
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="#" class="dropdown-item" onclick="handleLogout()">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Sign Out</span>
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <div class="content" id="mainContent">
            <!-- Content will be dynamically loaded here -->
            <div id="dashboardSection" class="content-section active">
                <!-- Dashboard content will be loaded here -->
            </div>
            <!-- Users List Section -->
<div id="usersListSection" class="content-section">
    <div class="users-container">
        <div class="users-header">
            <h2>User Management</h2>
            <button class="btn btn-primary" onclick="openAddUserModal()">
                <i class="fas fa-plus"></i> Add New User
            </button>
        </div>

        <div class="search-filter-container">
            <div class="search-bar">
                <i class="fas fa-search"></i>
                <input type="text" id="userSearch" placeholder="Search users by name, email, or role..." onkeyup="debounceSearch()">
            </div>
            
            <div class="filter-dropdown">
                <button class="filter-button" onclick="toggleFilterMenu()">
                    <i class="fas fa-filter"></i>
                    <span>Filter</span>
                </button>
                <div class="filter-menu" id="filterMenu">
                    <div class="filter-option" onclick="applyFilter('department')">Department</div>
                    <div class="filter-option" onclick="applyFilter('role')">Role</div>
                    <div class="filter-option" onclick="applyFilter('status')">Status</div>
                </div>
            </div>
        </div>

        <div class="users-table">
            <table>
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Email</th>
                        <th>Department</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>2FA</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <!-- Table content will be dynamically populated -->
                </tbody>
            </table>
        </div>

        <div class="pagination">
            <div class="pagination-info">
                Showing <span id="showingStart">0</span> to <span id="showingEnd">0</span> of <span id="totalUsers">0</span> users
            </div>
            <div class="pagination-buttons" id="paginationButtons">
                <!-- Pagination buttons will be dynamically populated -->
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit User Modal -->
<div class="modal" id="userModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Add New User</h3>
            <button class="modal-close" onclick="closeUserModal()">×</button>
        </div>
        <div class="modal-body">
            <form id="userForm">
                <div class="form-group">
                    <label for="userName">Full Name</label>
                    <input type="text" id="userName" required>
                </div>
                <div class="form-group">
                    <label for="userEmail">Email</label>
                    <input type="email" id="userEmail" required>
                </div>
                <div class="form-group">
                    <label for="userDepartment">Department</label>
                    <select id="userDepartment" required>
                        <option value="">Select Department</option>
                        <option value="Administration">Administration</option>
                        <option value="Product">Product</option>
                        <option value="HR">HR</option>
                        <option value="Finance">Finance</option>
                        <option value="IT">IT</option>
                        <option value="Support">Support</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="userRole">Role</label>
                    <select id="userRole" required>
                        <option value="">Select Role</option>
                        <option value="admin">Admin</option>
                        <option value="product_manager">Product Manager</option>
                        <option value="hr_admin">HR Admin</option>
                        <option value="finance_specialist">Finance Specialist</option>
                        <option value="data_analyst">Data Analyst</option>
                        <option value="api_developer">API Developer</option>
                        <option value="support_specialist">Support Specialist</option>
                        <option value="it_manager">IT Manager</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="requires2FA">Two-Factor Authentication</label>
                    <select id="requires2FA">
                        <option value="false">Disabled</option>
                        <option value="true">Enabled</option>
                    </select>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeUserModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveUser()">Save User</button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal" id="deleteModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Delete User</h3>
            <button class="modal-close" onclick="closeDeleteModal()">×</button>
        </div>
        <div class="modal-body">
            <p>Are you sure you want to delete this user? This action cannot be undone.</p>
            <div class="form-group">
                <label for="deleteReason">Reason for Deletion</label>
                <input type="text" id="deleteReason" required placeholder="Please provide a reason">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
            <button class="btn btn-danger" onclick="confirmDeleteUser()">Delete User</button>
        </div>
    </div>
</div>

<!-- Reset Password Modal -->
<div class="modal" id="resetPasswordModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Reset Password</h3>
            <button class="modal-close" onclick="closeResetPasswordModal()">×</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="newPassword">New Password</label>
                <input type="password" id="newPassword" required>
            </div>
            <div class="form-group">
                <label for="confirmPassword">Confirm Password</label>
                <input type="password" id="confirmPassword" required>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeResetPasswordModal()">Cancel</button>
            <button class="btn btn-primary" onclick="confirmResetPassword()">Reset Password</button>
        </div>
    </div>
</div>

            <!-- Roles & Permissions Section -->
<div id="rolesPermissionsSection" class="content-section">
    <div class="roles-container">
        <div class="roles-header">
            <h2>Roles & Permissions Management</h2>
            <button class="btn btn-primary" onclick="openAddRoleModal()">
                <i class="fas fa-plus"></i> Add New Role
            </button>
        </div>

        <!-- Roles List -->
        <div class="roles-grid">
            <!-- Superadmin Card -->
            <div class="role-card superadmin">
                <div class="role-header">
                    <i class="fas fa-crown"></i>
                    <h3>Superadmin</h3>
                </div>
                <div class="role-description">
                    Full system access with no restrictions. Cannot be modified.
                </div>
                <div class="role-stats">
                    <div class="stat">
                        <span class="stat-value" id="superadminCount">0</span>
                        <span class="stat-label">Users</span>
                    </div>
                </div>
                <div class="role-footer">
                    <button class="btn btn-secondary" disabled>
                        <i class="fas fa-lock"></i> System Role
                    </button>
                </div>
            </div>

            <!-- Dynamic Role Cards -->
            <div id="rolesGrid"></div>
        </div>
    </div>
</div>

<!-- Add/Edit Role Modal -->
<div class="modal" id="roleModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="roleModalTitle">Add New Role</h3>
            <button class="modal-close" onclick="closeRoleModal()">×</button>
        </div>
        <div class="modal-body">
            <form id="roleForm">
                <div class="form-group">
                    <label for="roleName">Role Name *</label>
                    <input type="text" id="roleName" required>
                </div>
                <div class="form-group">
                    <label for="roleDescription">Description *</label>
                    <textarea id="roleDescription" required></textarea>
                </div>
                
                <div class="permissions-section">
                    <h4>Permissions</h4>
                    
                    <!-- Dashboard Permissions -->
                    <div class="permission-group">
                        <h5>Dashboard Access</h5>
                        <label class="checkbox-container">
                            <input type="checkbox" id="perm_dashboard_view">
                            <span class="checkbox-label">View Dashboard</span>
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" id="perm_dashboard_analytics">
                            <span class="checkbox-label">Access Analytics</span>
                        </label>
                    </div>

                    <!-- User Management Permissions -->
                    <div class="permission-group">
                        <h5>User Management</h5>
                        <label class="checkbox-container">
                            <input type="checkbox" id="perm_users_view">
                            <span class="checkbox-label">View Users</span>
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" id="perm_users_create">
                            <span class="checkbox-label">Create Users</span>
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" id="perm_users_edit">
                            <span class="checkbox-label">Edit Users</span>
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" id="perm_users_delete">
                            <span class="checkbox-label">Delete Users</span>
                        </label>
                    </div>

                    <!-- System Settings Permissions -->
                    <div class="permission-group">
                        <h5>System Settings</h5>
                        <label class="checkbox-container">
                            <input type="checkbox" id="perm_settings_view">
                            <span class="checkbox-label">View Settings</span>
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" id="perm_settings_edit">
                            <span class="checkbox-label">Modify Settings</span>
                        </label>
                    </div>

                    <!-- Module Management Permissions -->
                    <div class="permission-group">
                        <h5>Module Management</h5>
                        <label class="checkbox-container">
                            <input type="checkbox" id="perm_modules_view">
                            <span class="checkbox-label">View Modules</span>
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" id="perm_modules_manage">
                            <span class="checkbox-label">Manage Modules</span>
                        </label>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeRoleModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveRole()">Save Role</button>
        </div>
    </div>
</div>
            
        </div>
        
    </main>
</div>
    <style>
        /* Roles & Permissions Styles */
.roles-container {
    padding: 1.5rem;
}

.roles-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.roles-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
}

.role-card {
    background: white;
    border-radius: 0.5rem;
    box-shadow: var(--box-shadow);
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.role-card.superadmin {
    border: 2px solid var(--primary-color);
    background: linear-gradient(to bottom right, white, var(--gradient-start));
}

.role-header {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.role-header i {
    font-size: 1.5rem;
    color: var(--primary-color);
}

.role-header h3 {
    margin: 0;
    color: var(--text-color);
}

.role-description {
    color: var(--light-text);
    font-size: 0.875rem;
}

.role-stats {
    display: flex;
    gap: 1rem;
    padding: 1rem 0;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
}

.stat {
    text-align: center;
}

.stat-value {
    display: block;
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--primary-color);
}

.stat-label {
    font-size: 0.75rem;
    color: var(--light-text);
}

.role-footer {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
}

/* Permissions Section Styles */
.permissions-section {
    margin-top: 1.5rem;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    padding-top: 1.5rem;
}

.permission-group {
    margin-bottom: 1.5rem;
}

.permission-group h5 {
    margin: 0 0 0.75rem 0;
    color: var(--text-color);
}

.checkbox-container {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
    cursor: pointer;
}

.checkbox-container input[type="checkbox"] {
    width: 1.25rem;
    height: 1.25rem;
    border-radius: 0.25rem;
    border: 2px solid var(--light-text);
    cursor: pointer;
}

.checkbox-label {
    font-size: 0.875rem;
    color: var(--text-color);
}

/* Role Actions */
.role-actions {
    display: flex;
    gap: 0.5rem;
}

.role-action-button {
    padding: 0.5rem;
    border: none;
    border-radius: 0.25rem;
    background: none;
    color: var(--text-color);
    cursor: pointer;
    transition: all 0.3s ease;
}

.role-action-button:hover {
    color: var(--primary-color);
}

/* Permission Matrix */
.permission-matrix {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
}

.permission-matrix th,
.permission-matrix td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

.permission-matrix th {
    background: var(--gradient-start);
    font-weight: 600;
}

.permission-matrix tr:hover {
    background: var(--gradient-start);
}
    </style>

<!-- Notification Template -->
<div class="notification" id="notification">
    <i class="fas fa-info-circle"></i>
    <span id="notificationMessage"></span>
</div>

    <script>
// Global Variables and Configuration
const API_BASE_URL = 'https://18.215.160.136.nip.io/api';
let currentUser = null;
let currentPage = 1;
let totalPages = 1;
let currentFilters = {
    search: '',
    department: '',
    role: '',
    status: ''
};
let selectedUserId = null;
let selectedRoleId = null;
let usersData = [];
let rolesData = [];

// Initialize Dashboard
document.addEventListener('DOMContentLoaded', async () => {
    try {
        const params = getQueryParams();
        if (params.token) {
            console.log('Fresh login detected, setting credentials');
            localStorage.setItem('token', params.token);
            localStorage.setItem('userRole', params.role);
            localStorage.setItem('userEmail', params.email);
            
            window.history.replaceState({}, document.title, window.location.pathname);
        }

        const isAuthenticated = await checkAuthentication();
        if (!isAuthenticated) {
            redirectToLogin();
            return;
        }

        initializeDashboard();
        loadUserInfo();
        loadInitialContent();
    } catch (error) {
        console.error('Dashboard initialization error:', error);
        redirectToLogin();
    }
});

// Error Handling
window.addEventListener('unhandledrejection', function(event) {
    console.error('Unhandled promise rejection:', event.reason);
    showNotification('An unexpected error occurred', 'error');
});

// API Service
const ApiService = {
    getHeaders() {
        const token = localStorage.getItem('token');
        return {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        };
    },

    async handleResponse(response) {
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({
                message: 'An error occurred'
            }));
            throw new Error(errorData.message || 'Request failed');
        }
        return response.json();
    },

    async get(endpoint) {
        try {
            const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                method: 'GET',
                headers: this.getHeaders()
            });
            return this.handleResponse(response);
        } catch (error) {
            console.error(`GET ${endpoint} failed:`, error);
            throw error;
        }
    },

    async post(endpoint, data) {
        try {
            const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                method: 'POST',
                headers: this.getHeaders(),
                body: JSON.stringify(data)
            });
            return this.handleResponse(response);
        } catch (error) {
            console.error(`POST ${endpoint} failed:`, error);
            throw error;
        }
    },

    async put(endpoint, data) {
        try {
            const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                method: 'PUT',
                headers: this.getHeaders(),
                body: JSON.stringify(data)
            });
            return this.handleResponse(response);
        } catch (error) {
            console.error(`PUT ${endpoint} failed:`, error);
            throw error;
        }
    },

    async delete(endpoint) {
        try {
            const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                method: 'DELETE',
                headers: this.getHeaders()
            });
            return this.handleResponse(response);
        } catch (error) {
            console.error(`DELETE ${endpoint} failed:`, error);
            throw error;
        }
    }
};

// Authentication Functions
async function checkAuthentication() {
    const token = getToken();
    if (!token) {
        return false;
    }

    try {
        const response = await fetch(`${API_BASE_URL}/verify-token`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (!response.ok) {
            throw new Error('Token verification failed');
        }

        const data = await response.json();
        
        if (data.user.role.toLowerCase() !== 'superadmin') {
            throw new Error('Unauthorized access');
        }

        currentUser = data.user;
        return true;
    } catch (error) {
        console.error('Authentication check failed:', error);
        localStorage.removeItem('token');
        localStorage.removeItem('userRole');
        localStorage.removeItem('userEmail');
        return false;
    }
}

function getToken() {
    return localStorage.getItem('token');
}

function getQueryParams() {
    const params = new URLSearchParams(window.location.search);
    return {
        email: params.get('email'),
        role: params.get('role'),
        token: params.get('token')
    };
}
        // Dashboard Functions
function initializeDashboard() {
    initializeSidebar();
    initializeEventListeners();
}

function initializeSidebar() {
    document.querySelectorAll('.menu-item').forEach(item => {
        item.addEventListener('click', async function(e) {
            if (!this.hasAttribute('onclick')) {
                e.preventDefault();
                const section = this.getAttribute('data-section');
                if (section) {
                    // Update active state
                    document.querySelectorAll('.menu-item').forEach(menuItem => {
                        menuItem.classList.remove('active');
                    });
                    this.classList.add('active');

                    // Load section content
                    await loadSectionContent(section);
                }
            }
        });
    });
}

async function loadDashboardContent(container) {
    try {
        showLoading(container);

        // Default statistics
        const defaultStats = {
            users: { total: 0, active: 0 },
            companies: { total: 0, active: 0 },
            auditLogs: []
        };

        // Fetch statistics with error handling
        const [usersStats, companiesStats, auditLogs] = await Promise.all([
            fetchUserStatistics().catch(() => defaultStats.users),
            fetchCompanyStatistics().catch(() => defaultStats.companies),
            fetchRecentAuditLogs().catch(() => defaultStats.auditLogs)
        ]);

        container.innerHTML = `
            <div class="dashboard-grid">
                <div class="stats-card">
                    <h3>Users Overview</h3>
                    <div class="stats-content">
                        <div class="stat-item">
                            <span class="stat-value">${usersStats.total || 0}</span>
                            <span class="stat-label">Total Users</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">${usersStats.active || 0}</span>
                            <span class="stat-label">Active Users</span>
                        </div>
                    </div>
                </div>
                
                <div class="stats-card">
                    <h3>Companies Overview</h3>
                    <div class="stats-content">
                        <div class="stat-item">
                            <span class="stat-value">${companiesStats.total || 0}</span>
                            <span class="stat-label">Total Companies</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">${companiesStats.active || 0}</span>
                            <span class="stat-label">Active Companies</span>
                        </div>
                    </div>
                </div>

                <div class="recent-activity">
                    <h3>Recent Activity</h3>
                    <div class="activity-list">
                        ${auditLogs.length > 0 ? 
                            auditLogs.map(log => `
                                <div class="activity-item">
                                    <div class="activity-icon">
                                        <i class="fas ${getActivityIcon(log.action)}"></i>
                                    </div>
                                    <div class="activity-details">
                                        <div class="activity-title">${formatActivityTitle(log)}</div>
                                        <div class="activity-time">${formatTimestamp(log.timestamp)}</div>
                                    </div>
                                </div>
                            `).join('') : 
                            '<div class="no-activity">No recent activity</div>'
                        }
                    </div>
                </div>
            </div>
        `;
    } catch (error) {
        console.error('Error loading dashboard content:', error);
        container.innerHTML = `
            <div class="error-container">
                <i class="fas fa-exclamation-circle"></i>
                <p>Failed to load dashboard content. Please try again later.</p>
            </div>
        `;
    } finally {
        hideLoading(container);
    }
}

// Statistics Functions
async function fetchUserStatistics() {
    try {
        const response = await makeAuthenticatedRequest('/users?limit=1');
        if (!response.ok) throw new Error('Failed to fetch user statistics');
        
        const data = await response.json();
        return {
            total: data.pagination.total || 0,
            active: data.users.filter(u => u.status === 'active').length || 0
        };
    } catch (error) {
        console.error('Error fetching user statistics:', error);
        return { total: 0, active: 0 };
    }
}

async function fetchCompanyStatistics() {
    try {
        // Since the companies endpoint doesn't exist yet, return default values
        return {
            total: 0,
            active: 0
        };
    } catch (error) {
        console.error('Error fetching company statistics:', error);
        return { total: 0, active: 0 };
    }
}

async function fetchRecentAuditLogs() {
    try {
        const response = await makeAuthenticatedRequest('/audit-logs?limit=5');
        if (!response.ok) throw new Error('Failed to fetch audit logs');
        
        const data = await response.json();
        return data.logs || [];
    } catch (error) {
        console.error('Error fetching audit logs:', error);
        return [];
    }
}

// User Management Functions
async function initializeUserManagement() {
    try {
        await loadUsers();
        setupUserEventListeners();
        setupUserModalEventListeners();
    } catch (error) {
        console.error('Error initializing user management:', error);
        showNotification('Failed to initialize user management', 'error');
    }
}

async function loadUsers() {
    try {
        showLoading(document.getElementById('usersTableBody'));
        
        const queryParams = new URLSearchParams({
            page: currentPage,
            limit: 10,
            ...(currentFilters.search && { search: currentFilters.search }),
            ...(currentFilters.department && { department: currentFilters.department }),
            ...(currentFilters.role && { role: currentFilters.role }),
            ...(currentFilters.status && { status: currentFilters.status })
        });

        const response = await makeAuthenticatedRequest(`/users?${queryParams}`);
        if (!response.ok) throw new Error('Failed to fetch users');

        const data = await response.json();
        usersData = data.users;
        totalPages = data.pagination.pages;

        updateUsersTable(data.users);
        updatePagination(data.pagination);
    } catch (error) {
        console.error('Error loading users:', error);
        showNotification('Failed to load users', 'error');
        document.getElementById('usersTableBody').innerHTML = `
            <tr>
                <td colspan="7" class="error-message">
                    Failed to load users. Please try again.
                </td>
            </tr>
        `;
    } finally {
        hideLoading(document.getElementById('usersTableBody'));
    }
}
// User Management Modal Functions
function openAddUserModal() {
    selectedUserId = null;
    document.getElementById('modalTitle').textContent = 'Add New User';
    document.getElementById('userForm').reset();
    document.getElementById('userModal').classList.add('active');
}

function closeUserModal() {
    document.getElementById('userModal').classList.remove('active');
    document.getElementById('userForm').reset();
    selectedUserId = null;
}

function editUser(userId) {
    try {
        const user = usersData.find(u => u._id === userId);
        if (!user) {
            showNotification('User not found', 'error');
            return;
        }

        selectedUserId = userId;
        document.getElementById('modalTitle').textContent = 'Edit User';
        
        // Populate form fields
        document.getElementById('userName').value = user.name || '';
        document.getElementById('userEmail').value = user.email || '';
        document.getElementById('userDepartment').value = user.department || '';
        document.getElementById('userRole').value = user.role || '';
        document.getElementById('requires2FA').value = (user.requires2FA || false).toString();

        // Show modal
        document.getElementById('userModal').classList.add('active');
    } catch (error) {
        console.error('Error editing user:', error);
        showNotification('Failed to load user data', 'error');
    }
}

async function saveUser() {
    try {
        // Get form values
        const userData = {
            name: document.getElementById('userName').value.trim(),
            email: document.getElementById('userEmail').value.trim(),
            department: document.getElementById('userDepartment').value,
            role: document.getElementById('userRole').value,
            requires2FA: document.getElementById('requires2FA').value === 'true'
        };

        // Validate required fields
        if (!userData.name || !userData.email || !userData.department || !userData.role) {
            showNotification('Please fill in all required fields', 'error');
            return;
        }

        // Validate email format
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(userData.email)) {
            showNotification('Please enter a valid email address', 'error');
            return;
        }

        if (selectedUserId) {
            // Update existing user
            await updateUser(selectedUserId, userData);
        } else {
            // Create new user
            const response = await makeAuthenticatedRequest('/users', {
                method: 'POST',
                body: JSON.stringify(userData)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to create user');
            }

            showNotification('User created successfully', 'success');
            await loadUsers();
        }

        closeUserModal();
    } catch (error) {
        console.error('Error saving user:', error);
        showNotification(error.message || 'Failed to save user', 'error');
    }
}

async function updateUser(userId, userData) {
    try {
        const response = await makeAuthenticatedRequest(`/users/${userId}`, {
            method: 'PUT',
            body: JSON.stringify(userData)
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Failed to update user');
        }

        showNotification('User updated successfully', 'success');
        await loadUsers();
    } catch (error) {
        console.error('Error updating user:', error);
        showNotification(error.message || 'Failed to update user', 'error');
    }
}

async function toggleUserStatus(userId, currentStatus) {
    try {
        const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
        const response = await makeAuthenticatedRequest(`/users/${userId}/status`, {
            method: 'PUT',
            body: JSON.stringify({ status: newStatus })
        });

        if (!response.ok) throw new Error('Failed to update user status');

        showNotification('User status updated successfully', 'success');
        loadUsers();
    } catch (error) {
        console.error('Error updating user status:', error);
        showNotification('Failed to update user status', 'error');
    }
}

async function toggle2FA(userId, current2FAStatus) {
    try {
        const response = await makeAuthenticatedRequest(`/users/${userId}/2fa`, {
            method: 'PUT',
            body: JSON.stringify({ requires2FA: !current2FAStatus })
        });

        if (!response.ok) throw new Error('Failed to update 2FA status');

        showNotification('2FA status updated successfully', 'success');
        loadUsers();
    } catch (error) {
        console.error('Error updating 2FA status:', error);
        showNotification('Failed to update 2FA status', 'error');
    }
}

// Password Reset Functions
function openResetPasswordModal(userId) {
    selectedUserId = userId;
    document.getElementById('resetPasswordModal').classList.add('active');
}

function closeResetPasswordModal() {
    document.getElementById('resetPasswordModal').classList.remove('active');
    document.getElementById('newPassword').value = '';
    document.getElementById('confirmPassword').value = '';
    selectedUserId = null;
}

async function confirmResetPassword() {
    try {
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (newPassword !== confirmPassword) {
            showNotification('Passwords do not match', 'error');
            return;
        }

        const response = await makeAuthenticatedRequest(`/users/${selectedUserId}/reset-password`, {
            method: 'POST',
            body: JSON.stringify({ password: newPassword })
        });

        if (!response.ok) throw new Error('Failed to reset password');

        showNotification('Password reset successfully', 'success');
        closeResetPasswordModal();
    } catch (error) {
        console.error('Error resetting password:', error);
        showNotification('Failed to reset password', 'error');
    }
}

// Delete User Functions
function openDeleteModal(userId) {
    selectedUserId = userId;
    document.getElementById('deleteModal').classList.add('active');
}

function closeDeleteModal() {
    document.getElementById('deleteModal').classList.remove('active');
    document.getElementById('deleteReason').value = '';
    selectedUserId = null;
}

async function confirmDeleteUser() {
    try {
        const reason = document.getElementById('deleteReason').value;
        if (!reason) {
            showNotification('Please provide a reason for deletion', 'error');
            return;
        }

        const response = await makeAuthenticatedRequest(`/users/${selectedUserId}`, {
            method: 'DELETE',
            body: JSON.stringify({ reason })
        });

        if (!response.ok) throw new Error('Failed to delete user');

        showNotification('User deleted successfully', 'success');
        closeDeleteModal();
        loadUsers();
    } catch (error) {
        console.error('Error deleting user:', error);
        showNotification('Failed to delete user', 'error');
    }
}
        // Role Management Functions
async function initializeRolesManagement() {
    try {
        console.log('Initializing roles management...');
        await loadRoles();
        setupRolesEventListeners();
        console.log('Roles management initialized successfully');
    } catch (error) {
        console.error('Error initializing roles management:', error);
        showNotification('Failed to initialize roles management', 'error');
    }
}

async function loadRoles() {
    try {
        showLoading(document.getElementById('rolesGrid'));
        
        const response = await makeAuthenticatedRequest('/roles');
        if (!response.ok) throw new Error('Failed to fetch roles');

        const data = await response.json();
        if (data.success) {
            rolesData = data.roles;
            updateRolesGrid(data.roles);
        } else {
            throw new Error(data.message || 'Failed to fetch roles');
        }
    } catch (error) {
        console.error('Error loading roles:', error);
        const rolesGrid = document.getElementById('rolesGrid');
        if (rolesGrid) {
            rolesGrid.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-circle"></i>
                    <p>Failed to load roles. Please try again later.</p>
                </div>
            `;
        }
        showNotification('Failed to load roles', 'error');
    } finally {
        hideLoading(document.getElementById('rolesGrid'));
    }
}

// Pagination Functions
function updatePagination(pagination) {
    const { total, page, pages } = pagination;
    const start = (page - 1) * 10 + 1;
    const end = Math.min(page * 10, total);

    document.getElementById('showingStart').textContent = start;
    document.getElementById('showingEnd').textContent = end;
    document.getElementById('totalUsers').textContent = total;

    const paginationButtons = document.getElementById('paginationButtons');
    paginationButtons.innerHTML = `
        <button class="pagination-button" onclick="changePage(1)" ${page === 1 ? 'disabled' : ''}>
            <i class="fas fa-angle-double-left"></i>
        </button>
        <button class="pagination-button" onclick="changePage(${page - 1})" ${page === 1 ? 'disabled' : ''}>
            <i class="fas fa-angle-left"></i>
        </button>
        ${generatePageButtons(page, pages)}
        <button class="pagination-button" onclick="changePage(${page + 1})" ${page === pages ? 'disabled' : ''}>
            <i class="fas fa-angle-right"></i>
        </button>
        <button class="pagination-button" onclick="changePage(${pages})" ${page === pages ? 'disabled' : ''}>
            <i class="fas fa-angle-double-right"></i>
        </button>
    `;
}

function generatePageButtons(currentPage, totalPages) {
    let buttons = [];
    let startPage = Math.max(1, currentPage - 2);
    let endPage = Math.min(totalPages, currentPage + 2);

    if (startPage > 1) {
        buttons.push(`<span class="pagination-ellipsis">...</span>`);
    }

    for (let i = startPage; i <= endPage; i++) {
        buttons.push(`
            <button class="pagination-button ${i === currentPage ? 'active' : ''}" 
                    onclick="changePage(${i})">
                ${i}
            </button>
        `);
    }

    if (endPage < totalPages) {
        buttons.push(`<span class="pagination-ellipsis">...</span>`);
    }

    return buttons.join('');
}

function changePage(page) {
    if (page < 1 || page > totalPages) return;
    currentPage = page;
    loadUsers();
}

// Event Listeners Setup
function setupEventListeners() {
    // Sidebar toggle
    const toggleSidebarBtn = document.getElementById('toggleSidebar');
    if (toggleSidebarBtn) {
        toggleSidebarBtn.addEventListener('click', () => {
            document.querySelector('.sidebar').classList.toggle('active');
        });
    }

    // Close sidebar
    const closeSidebarBtn = document.getElementById('closeSidebar');
    if (closeSidebarBtn) {
        closeSidebarBtn.addEventListener('click', () => {
            document.querySelector('.sidebar').classList.remove('active');
        });
    }

    // User dropdown
    document.addEventListener('click', function(event) {
        if (!event.target.closest('.user-menu')) {
            const userDropdown = document.getElementById('userDropdown');
            if (userDropdown) {
                userDropdown.classList.remove('active');
            }
        }
    });

    // Search input
    const searchInput = document.getElementById('userSearch');
    if (searchInput) {
        searchInput.addEventListener('keyup', debounceSearch);
    }

    // Filter menu close
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.filter-dropdown')) {
            const filterMenu = document.getElementById('filterMenu');
            if (filterMenu) {
                filterMenu.classList.remove('active');
            }
        }
    });

    // Submenu click outside close
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.menu-item')) {
            document.querySelectorAll('.submenu').forEach(submenu => {
                submenu.classList.remove('active');
            });
        }
    });
}

function setupUserModalEventListeners() {
    // Form submission handling
    const userForm = document.getElementById('userForm');
    if (userForm) {
        userForm.addEventListener('submit', (e) => {
            e.preventDefault();
            saveUser();
        });
    }

    // Modal close handling
    const modalClose = document.querySelector('.modal-close');
    if (modalClose) {
        modalClose.addEventListener('click', closeUserModal);
    }

    // Close modal when clicking outside
    window.addEventListener('click', (e) => {
        const modal = document.getElementById('userModal');
        if (e.target === modal) {
            closeUserModal();
        }
    });
}

function setupRolesEventListeners() {
    // Role modal events
    const roleModal = document.getElementById('roleModal');
    if (roleModal) {
        // Close modal when clicking outside
        roleModal.addEventListener('click', (e) => {
            if (e.target === roleModal) {
                closeRoleModal();
            }
        });

        // Form submission
        const roleForm = document.getElementById('roleForm');
        if (roleForm) {
            roleForm.addEventListener('submit', (e) => {
                e.preventDefault();
                saveRole();
            });
        }
    }
}
        // Search and Filter Functions
let searchTimeout;
function debounceSearch() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        currentFilters.search = document.getElementById('userSearch').value;
        currentPage = 1;
        loadUsers();
    }, 300);
}

function toggleFilterMenu() {
    document.getElementById('filterMenu').classList.toggle('active');
}

function applyFilter(filterType) {
    const value = prompt(`Enter ${filterType}:`);
    if (value !== null) {
        currentFilters[filterType] = value;
        currentPage = 1;
        loadUsers();
    }
    toggleFilterMenu();
}

// Utility Functions
function showLoading(element) {
    if (element) {
        element.innerHTML = `
            <div class="loading-container">
                <div class="loading-spinner"></div>
                <p>Loading...</p>
            </div>
        `;
    }
}

function hideLoading(element) {
    const loadingContainer = element?.querySelector('.loading-container');
    if (loadingContainer) {
        loadingContainer.remove();
    }
}

function showNotification(message, type = 'success') {
    const notification = document.getElementById('notification');
    if (!notification) {
        const notificationElement = document.createElement('div');
        notificationElement.id = 'notification';
        notificationElement.className = 'notification';
        document.body.appendChild(notificationElement);
    }

    const notificationElement = document.getElementById('notification');
    notificationElement.className = `notification ${type}`;
    notificationElement.innerHTML = `
        <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
        <span>${message}</span>
    `;
    notificationElement.classList.add('show');

    setTimeout(() => {
        notificationElement.classList.remove('show');
    }, 3000);
}

function escapeHtml(unsafe) {
    if (typeof unsafe !== 'string') return '';
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

function formatTimestamp(timestamp) {
    return new Date(timestamp).toLocaleString();
}

function getActivityIcon(action) {
    const icons = {
        'USER_CREATED': 'fa-user-plus',
        'USER_UPDATED': 'fa-user-edit',
        'USER_DELETED': 'fa-user-minus',
        'USER_LOGIN': 'fa-sign-in-alt',
        'ROLE_CREATED': 'fa-plus-circle',
        'ROLE_UPDATED': 'fa-edit',
        'ROLE_DELETED': 'fa-trash-alt',
        'default': 'fa-info-circle'
    };
    return icons[action] || icons.default;
}

function getRoleIcon(roleName) {
    const icons = {
        'Superadmin': 'fa-crown',
        'Admin': 'fa-user-shield',
        'Product Manager': 'fa-tasks',
        'HR Admin': 'fa-users-cog',
        'Finance Specialist': 'fa-dollar-sign',
        'Data Analyst': 'fa-chart-line',
        'API Developer': 'fa-code',
        'Support Specialist': 'fa-headset',
        'IT Manager': 'fa-server',
        'default': 'fa-user-tie'
    };
    return icons[roleName] || icons.default;
}

function formatActivityTitle(log) {
    return `${log.action.replace(/_/g, ' ')} by ${log.performedByUser?.email || 'System'}`;
}

function getSelectedPermissions() {
    return Array.from(document.querySelectorAll('input[type="checkbox"][id^="perm_"]'))
        .filter(cb => cb.checked)
        .map(cb => cb.id.replace('perm_', ''));
}

function resetPermissionCheckboxes() {
    document.querySelectorAll('input[type="checkbox"][id^="perm_"]').forEach(checkbox => {
        checkbox.checked = false;
    });
}

// User Menu Functions
function toggleUserMenu() {
    document.getElementById('userDropdown').classList.toggle('active');
}

function handleLogout() {
    localStorage.clear();
    window.location.href = 'login.html';
}

function redirectToLogin() {
    localStorage.clear();
    window.location.href = 'login.html';
}

// Validation Functions
function validateUserData(userData) {
    const errors = [];

    if (!userData.name || userData.name.trim().length < 2) {
        errors.push('Name must be at least 2 characters long');
    }

    if (!userData.email || !userData.email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
        errors.push('Please enter a valid email address');
    }

    if (!userData.department) {
        errors.push('Please select a department');
    }

    if (!userData.role) {
        errors.push('Please select a role');
    }

    return errors;
}

// Content Loading Functions
function loadInitialContent() {
    loadSectionContent('dashboard');
}

async function loadSectionContent(section) {
    try {
        // Hide all sections first
        document.querySelectorAll('.content-section').forEach(s => {
            if (s) s.style.display = 'none';
        });

        // Update page title
        const pageTitle = document.getElementById('pageTitle');
        if (pageTitle) {
            pageTitle.textContent = section.charAt(0).toUpperCase() + 
                                  section.slice(1).replace('-', ' ');
        }

        switch (section) {
            case 'dashboard':
                const dashboardSection = document.getElementById('dashboardSection');
                if (dashboardSection) {
                    dashboardSection.style.display = 'block';
                    await loadDashboardContent(dashboardSection);
                }
                break;

            case 'users-list':
                const usersSection = document.getElementById('usersListSection');
                if (usersSection) {
                    usersSection.style.display = 'block';
                    await initializeUserManagement();
                }
                break;

            case 'roles-permissions':
                const rolesSection = document.getElementById('rolesPermissionsSection');
                if (rolesSection) {
                    rolesSection.style.display = 'block';
                    await initializeRolesManagement();
                }
                break;

            default:
                const mainContent = document.getElementById('mainContent');
                if (mainContent) {
                    mainContent.innerHTML = `
                        <div class="content-section" style="display: block">
                            <h2>Section ${escapeHtml(section)} is under development</h2>
                        </div>
                    `;
                }
                break;
        }
    } catch (error) {
        console.error(`Error loading ${section} content:`, error);
        showNotification(`Failed to load ${section} section. Please try again.`, 'error');
    }
}

// Initialize everything when the page loads
document.addEventListener('DOMContentLoaded', () => {
    setupEventListeners();
    initializeDashboard();
});

</script>
</body>
</html>

